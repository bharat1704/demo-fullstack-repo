name: Simple CI/CD - Backend ECS

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

env:
  AWS_REGION: us-east-1
  ECS_CLUSTER: test-backend-cluster
  ECS_SERVICE: backend-task-service-i3o5pj2b
  ECR_REPO: ${{ secrets.ECR_REPO }}
  ECR_URI: ${{ secrets.ECR_URI }}
  IMAGE_TAG: latest
  STAGING_SERVICE: backend-staging-service       # optional staging ECS service
  PRODUCTION_SERVICE: backend-prod-service       # optional prod ECS service

jobs:
  ##########################################
  # 1Ô∏è‚É£ Build and Test (runs on PR & Push)
  ##########################################
  build-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install Dependencies
        working-directory: backend
        run: npm ci

      - name: Run Unit and Integration Tests
        working-directory: backend
        run: |
          npm test || exit 1

      - name: Scan Dependencies for Vulnerabilities
        uses: actions/setup-node@v4
        with:
          node-version: 18
        continue-on-error: true
      - run: |
          npm audit --production || true

  ##########################################
  # 2Ô∏è‚É£ Build, Scan & Push Docker Image
  ##########################################
  docker-build-push:
    needs: build-test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build Docker image
        working-directory: backend
        run: docker build -t $ECR_REPO:$IMAGE_TAG .

      - name: Scan Docker Image for Vulnerabilities
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.ECR_REPO }}:${{ env.IMAGE_TAG }}
          format: 'table'
          severity: 'CRITICAL,HIGH'
        continue-on-error: true

      - name: Tag & Push Docker Image
        run: |
          docker tag $ECR_REPO:$IMAGE_TAG $ECR_URI:$IMAGE_TAG
          docker push $ECR_URI:$IMAGE_TAG

  ##########################################
  # 3Ô∏è‚É£ Deploy to STAGING ECS
  ##########################################
  deploy-staging:
    needs: docker-build-push
    runs-on: ubuntu-latest
    environment: staging

    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get current ECS Task Definition
        run: |
          aws ecs describe-task-definition \
            --task-definition backend-task \
            --query taskDefinition \
            --output json > task-def.json
          cat task-def.json | jq 'del(.enableFaultInjection)' > clean-task-def.json

      - name: Update image in task definition
        id: render-task-def
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: clean-task-def.json
          container-name: backend
          image: ${{ env.ECR_URI }}:${{ env.IMAGE_TAG }}

      - name: Deploy to Staging ECS
        uses: aws-actions/amazon-ecs-deploy-task-definition@v1
        with:
          task-definition: ${{ steps.render-task-def.outputs.task-definition }}
          service: ${{ env.STAGING_SERVICE }}
          cluster: ${{ env.ECS_CLUSTER }}
          wait-for-service-stability: true

  ##########################################
  # 4Ô∏è‚É£ Manual Approval for Production
  ##########################################
  approval:
    needs: deploy-staging
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
    steps:
      - name: Await Manual Approval
        uses: trstringer/manual-approval@v1
        with:
          approvers: ${{ secrets.APPROVERS }}
          secret: ${{ secrets.GITHUB_TOKEN }}
          instructions: "Approve to deploy to PRODUCTION environment"

  ##########################################
  # 5Ô∏è‚É£ Deploy to PRODUCTION ECS
  ##########################################
  deploy-production:
    needs: approval
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get current ECS Task Definition
        run: |
          aws ecs describe-task-definition \
            --task-definition backend-task \
            --query taskDefinition \
            --output json > task-def.json
          cat task-def.json | jq 'del(.enableFaultInjection)' > clean-task-def.json

      - name: Update image in task definition
        id: render-task-def
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: clean-task-def.json
          container-name: backend
          image: ${{ env.ECR_URI }}:${{ env.IMAGE_TAG }}

      - name: Deploy to Production ECS
        uses: aws-actions/amazon-ecs-deploy-task-definition@v1
        with:
          task-definition: ${{ steps.render-task-def.outputs.task-definition }}
          service: ${{ env.PRODUCTION_SERVICE }}
          cluster: ${{ env.ECS_CLUSTER }}
          wait-for-service-stability: true

  ##########################################
  # 6Ô∏è‚É£ Notify on Failure
  ##########################################
  notify-on-failure:
    if: failure()
    runs-on: ubuntu-latest

    steps:
      - name: Send Failure Notification via Email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "üö® CI/CD Pipeline Failed for Backend ECS"
          to: ${{ secrets.NOTIFY_EMAIL }}
          from: "GitHub Actions <${{ secrets.SMTP_USERNAME }}>"
          body: |
            The GitHub Actions pipeline for the backend ECS service has failed.
            Repository: ${{ github.repository }}
            Run ID: ${{ github.run_id }}
            Check logs here: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
