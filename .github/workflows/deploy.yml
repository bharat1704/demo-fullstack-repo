name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Run backend tests
        working-directory: backend
        run: npm install && npm test

  docker:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build, tag, and push Docker image
        run: |
          docker build -t ${{ secrets.ECR_REPO }} ./backend
          docker tag ${{ secrets.ECR_REPO }}:latest ${{ secrets.ECR_URI }}:latest
          docker push ${{ secrets.ECR_URI }}:latest

  deploy:
    needs: docker
    runs-on: ubuntu-latest
    steps:
      - name: Deploy ECS Service
        uses: aws-actions/amazon-ecs-deploy-task-definition@v1
        with:
          task-definition: ecs-task-def.json
          service: bharat-backend-service
          cluster: bharat-backend-cluster
          wait-for-service-stability: true


########Second Version


name: CI/CD Pipeline - Backend (ECS)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  AWS_REGION: us-east-1
  ECR_REPO: ${{ secrets.ECR_REPO }}
  ECR_URI: ${{ secrets.ECR_URI }}
  ECS_CLUSTER: bharat-backend-cluster
  ECS_SERVICE: bharat-backend-service

jobs:
  # 1️⃣ Run Tests
  test:
    name: Run Backend Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install & Test
        working-directory: backend
        run: |
          npm ci
          npm test

  # 2️⃣ Build & Push Docker Image
  docker:
    name: Build and Push Docker Image
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build Docker Image
        run: docker build -t $ECR_REPO ./backend

      - name: Scan Image for Vulnerabilities (Trivy)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: $ECR_REPO
          severity: CRITICAL,HIGH
          ignore-unfixed: true
          exit-code: 1

      - name: Tag and Push Image
        run: |
          docker tag $ECR_REPO:latest $ECR_URI:latest
          docker push $ECR_URI:latest

  # 3️⃣ Manual Approval for Production
  approval:
    name: Manual Approval (Prod)
    needs: docker
    runs-on: ubuntu-latest
    environment:
      name: production
      # ✅ This triggers GitHub's built-in manual approval step
      # Go to Repo → Settings → Environments → production → set approvers
    steps:
      - name: Await Approval
        run: echo "Waiting for approval to deploy to production"

  # 4️⃣ Deploy to ECS (Staging/Prod)
  deploy:
    name: Deploy to ECS
    needs: approval
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy ECS Service
        uses: aws-actions/amazon-ecs-deploy-task-definition@v1
        with:
          service: ${{ env.ECS_SERVICE }}
          cluster: ${{ env.ECS_CLUSTER }}
          wait-for-service-stability: true

  # 5️⃣ Slack Notification (on failure)
  notify:
    name: Notify on Failure
    needs: [test, docker, deploy]
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Send Slack Alert
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_COLOR: danger
          SLACK_MESSAGE: "❌ Deployment failed in `${{ github.workflow }}` for commit `${{ github.sha }}` by `${{ github.actor }}`"
          SLACK_USERNAME: "CI/CD Bot"
